<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>An introduction to scMerge2 • scMerge</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="An introduction to scMerge2">
<meta property="og:description" content="scMerge">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">scMerge</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.15.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/scMerge.html">scMerge</a>
</li>
<li>
  <a href="../articles/scMerge2.html">scMerge2</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/SydneyBioX/scMerge" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>An introduction to scMerge2</h1>
                        <h4 data-toc-skip class="author">Yingxin
Lin</h4>
            <address class="author_afil">
      School of Mathematics and Statistics, The University of Sydney,
Australia<br><small class="dont-index">Source: <a href="https://github.com/SydneyBioX/scMerge/blob/HEAD/vignettes/scMerge2.Rmd" class="external-link"><code>vignettes/scMerge2.Rmd</code></a></small>
      <div class="hidden name"><code>scMerge2.Rmd</code></div>

    </address>
</div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The scMerge algorithm allows batch effect removal and normalisation
for single cell RNA-Seq data. It comprises of three key components
including:</p>
<ol style="list-style-type: decimal">
<li>The identification of stably expressed genes (SEGs) as “negative
controls” for estimating unwanted factors;</li>
<li>The construction of pseudo-replicates to estimate the effects of
unwanted factors; and</li>
<li>The adjustment of the datasets with unwanted variation using a
fastRUVIII model.</li>
</ol>
<p>The purpose of this vignette is to illustrate some uses of
<code>scMerge</code> and explain its key components.</p>
</div>
<div class="section level2">
<h2 id="loading-packages-and-data">Loading Packages and Data<a class="anchor" aria-label="anchor" href="#loading-packages-and-data"></a>
</h2>
<p>We will load the <code>scMerge</code> package. We designed our
package to be consistent with the popular BioConductor’s single cell
analysis framework, namely the <code>SingleCellExperiment</code> and
<code>scater</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/SydneyBioX/scMerge" class="external-link">scMerge</a></span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioconductor.org/packages/scater/" class="external-link">scater</a></span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We provided an illustrative mouse embryonic stem cell (mESC) data in
our package, as well as a set of pre-computed stably expressed gene
(SEG) list to be used as negative control genes.</p>
<p>The full curated, unnormalised mESC data can be found <a href="http://www.maths.usyd.edu.au/u/yingxinl/wwwnb/scMergeData/sce_mESC.rda" class="external-link">here</a>.
The <code>scMerge</code> package comes with a sub-sampled, two-batches
version of this data (named “batch2” and “batch3” to be consistent with
the full data) .</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Subsetted mouse ESC data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"example_sce"</span>, package <span class="op">=</span> <span class="st">"scMerge"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"segList_ensemblGeneID"</span>, package <span class="op">=</span> <span class="st">"scMerge"</span><span class="op">)</span></span></code></pre></div>
<p>In this mESC data, we pooled data from 2 different batches from three
different cell types. Using a PCA plot, we can see that despite strong
separation of cell types, there is also a strong separation due to batch
effects. This information is stored in the <code>colData</code> of
<code>example_sce</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_sce</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocSingular/man/runPCA.html" class="external-link">runPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, exprs_values <span class="op">=</span> <span class="st">"logcounts"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/plotPCA.html" class="external-link">plotPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, </span>
<span>                colour_by <span class="op">=</span> <span class="st">"cellTypes"</span>, </span>
<span>                shape_by <span class="op">=</span> <span class="st">"batch"</span><span class="op">)</span></span></code></pre></div>
<p><img src="scMerge2_files/figure-html/checking%20raw%20data-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="scmerge2">scMerge2<a class="anchor" aria-label="anchor" href="#scmerge2"></a>
</h2>
<div class="section level3">
<h3 id="unsupervised-scmerge2">Unsupervised <code>scMerge2</code><a class="anchor" aria-label="anchor" href="#unsupervised-scmerge2"></a>
</h3>
<p>In unsupervised <code>scMerge2</code>, we will perform graph
clustering on shared nearest neighbour graphs within each batch to
obtain pseudo-replicates. This requires the users to supply a
<code>k_celltype</code> vector with the number of neighbour when
constructed the nearest neighbour graph in each of the batches. By
default, this number is 10.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scMerge2_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scMerge2.html">scMerge2</a></span><span class="op">(</span>exprsMat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span>,</span>
<span>                         batch <span class="op">=</span> <span class="va">example_sce</span><span class="op">$</span><span class="va">batch</span>,</span>
<span>                         ctl <span class="op">=</span> <span class="va">segList_ensemblGeneID</span><span class="op">$</span><span class="va">mouse</span><span class="op">$</span><span class="va">mouse_scSEG</span>,</span>
<span>                         verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (A, nv = 5, nu = nv, maxit = 1000, work = nv + 7, reorth =</span></span>
<span><span class="co">#&gt; TRUE, : You're computing too large a percentage of total singular values, use a</span></span>
<span><span class="co">#&gt; standard svd instead.</span></span>
<span><span class="co">#&gt; Warning in (function (A, nv = 5, nu = nv, maxit = 1000, work = nv + 7, reorth =</span></span>
<span><span class="co">#&gt; TRUE, : You're computing too large a percentage of total singular values, use a</span></span>
<span><span class="co">#&gt; standard svd instead.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">example_sce</span>, <span class="st">"scMerge2"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">scMerge2_res</span><span class="op">$</span><span class="va">newY</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span>
<span><span class="va">example_sce</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocSingular/man/runPCA.html" class="external-link">runPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, exprs_values <span class="op">=</span> <span class="st">'scMerge2'</span><span class="op">)</span>                                       </span>
<span><span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/plotPCA.html" class="external-link">plotPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, colour_by <span class="op">=</span> <span class="st">'cellTypes'</span>, shape <span class="op">=</span> <span class="st">'batch'</span><span class="op">)</span></span></code></pre></div>
<p><img src="scMerge2_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="semi-supervised-scmerge2">Semi-supervised <code>scMerge2</code><a class="anchor" aria-label="anchor" href="#semi-supervised-scmerge2"></a>
</h3>
<p>When cell type information are known (e.g. results from cell type
classification using reference), scMerge2 can use this information to
construct pseudo-replicates and identify mutual nearest groups with
<code>cellTypes</code> input.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scMerge2_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scMerge2.html">scMerge2</a></span><span class="op">(</span>exprsMat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span>,</span>
<span>                         batch <span class="op">=</span> <span class="va">example_sce</span><span class="op">$</span><span class="va">batch</span>,</span>
<span>                         cellTypes <span class="op">=</span> <span class="va">example_sce</span><span class="op">$</span><span class="va">cellTypes</span>,</span>
<span>                         ctl <span class="op">=</span> <span class="va">segList_ensemblGeneID</span><span class="op">$</span><span class="va">mouse</span><span class="op">$</span><span class="va">mouse_scSEG</span>,</span>
<span>                         verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">example_sce</span>, <span class="st">"scMerge2"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">scMerge2_res</span><span class="op">$</span><span class="va">newY</span></span>
<span></span>
<span><span class="va">example_sce</span> <span class="op">=</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocSingular/man/runPCA.html" class="external-link">runPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, exprs_values <span class="op">=</span> <span class="st">'scMerge2'</span><span class="op">)</span>                                       </span>
<span><span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/plotPCA.html" class="external-link">plotPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, colour_by <span class="op">=</span> <span class="st">'cellTypes'</span>, shape <span class="op">=</span> <span class="st">'batch'</span><span class="op">)</span></span></code></pre></div>
<p><img src="scMerge2_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="more-details-of-scmerge2">More details of scMerge2<a class="anchor" aria-label="anchor" href="#more-details-of-scmerge2"></a>
</h2>
<div class="section level3">
<h3 id="number-of-pseudobulk">Number of pseudobulk<a class="anchor" aria-label="anchor" href="#number-of-pseudobulk"></a>
</h3>
<p>The number of pseudobulk constructed within each cell grouping is set
via <code>k_pseudoBulk</code>. By default, this number is set as 30. A
larger number will create more pseudo-bulk data in model estimation,
with longer time in estimation.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scMerge2_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scMerge2.html">scMerge2</a></span><span class="op">(</span>exprsMat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span>,</span>
<span>                         batch <span class="op">=</span> <span class="va">example_sce</span><span class="op">$</span><span class="va">batch</span>,</span>
<span>                         ctl <span class="op">=</span> <span class="va">segList_ensemblGeneID</span><span class="op">$</span><span class="va">mouse</span><span class="op">$</span><span class="va">mouse_scSEG</span>,</span>
<span>                         k_pseudoBulk <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                         verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (A, nv = 5, nu = nv, maxit = 1000, work = nv + 7, reorth =</span></span>
<span><span class="co">#&gt; TRUE, : You're computing too large a percentage of total singular values, use a</span></span>
<span><span class="co">#&gt; standard svd instead.</span></span>
<span><span class="co">#&gt; Warning in (function (A, nv = 5, nu = nv, maxit = 1000, work = nv + 7, reorth =</span></span>
<span><span class="co">#&gt; TRUE, : You're computing too large a percentage of total singular values, use a</span></span>
<span><span class="co">#&gt; standard svd instead.</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">example_sce</span>, <span class="st">"scMerge2"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">scMerge2_res</span><span class="op">$</span><span class="va">newY</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span>
<span><span class="va">example_sce</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocSingular/man/runPCA.html" class="external-link">runPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, exprs_values <span class="op">=</span> <span class="st">'scMerge2'</span><span class="op">)</span>                                       </span>
<span><span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/plotPCA.html" class="external-link">plotPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, colour_by <span class="op">=</span> <span class="st">'cellTypes'</span>, shape <span class="op">=</span> <span class="st">'batch'</span><span class="op">)</span></span></code></pre></div>
<p><img src="scMerge2_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="return-matrix-by-batch">Return matrix by batch<a class="anchor" aria-label="anchor" href="#return-matrix-by-batch"></a>
</h3>
<p>When working with large data, we can get the adjusted matrix for a
smaller subset of cells each time. This can be achieved by setting
<code>return_matrix</code> to <code>FALSE</code> in
<code><a href="../reference/scMerge2.html">scMerge2()</a></code> function, which the function then will not
return the adjusted whole matrix but will output the estimated
<code>fullalpha</code>. Then to get the adjusted matrix using the
estimated <code>fullalpha</code>, we first need to performed cosine
normalisation on the logcounts matrix and then calculate the row-wise
(gene-wise) mean of the cosine normalised matrix (This is because by
default, <code><a href="../reference/scMerge2.html">scMerge2()</a></code> perform cosine normalisation on the
log-normalised matrix before <code>RUVIII</code> step). Then we can use
<code><a href="../reference/getAdjustedMat.html">getAdjustedMat()</a></code> to adjust the matrix of a subset of cells
each time.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scMerge2_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scMerge2.html">scMerge2</a></span><span class="op">(</span>exprsMat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span>,</span>
<span>                         batch <span class="op">=</span> <span class="va">example_sce</span><span class="op">$</span><span class="va">batch</span>,</span>
<span>                         ctl <span class="op">=</span> <span class="va">segList_ensemblGeneID</span><span class="op">$</span><span class="va">mouse</span><span class="op">$</span><span class="va">mouse_scSEG</span>,</span>
<span>                         verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                         return_matrix <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (A, nv = 5, nu = nv, maxit = 1000, work = nv + 7, reorth =</span></span>
<span><span class="co">#&gt; TRUE, : You're computing too large a percentage of total singular values, use a</span></span>
<span><span class="co">#&gt; standard svd instead.</span></span>
<span><span class="co">#&gt; Warning in (function (A, nv = 5, nu = nv, maxit = 1000, work = nv + 7, reorth =</span></span>
<span><span class="co">#&gt; TRUE, : You're computing too large a percentage of total singular values, use a</span></span>
<span><span class="co">#&gt; standard svd instead.</span></span>
<span></span>
<span><span class="va">cosineNorm_mat</span> <span class="op">&lt;-</span> <span class="fu">batchelor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/batchelor/man/cosineNorm.html" class="external-link">cosineNorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">adjusted_means</span> <span class="op">&lt;-</span> <span class="fu">DelayedMatrixStats</span><span class="fu">::</span><span class="fu">rowMeans2</span><span class="op">(</span><span class="va">cosineNorm_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">newY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Factor-class.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">$</span><span class="va">batch</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">newY</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getAdjustedMat.html">getAdjustedMat</a></span><span class="op">(</span><span class="va">cosineNorm_mat</span><span class="op">[</span>, <span class="va">example_sce</span><span class="op">$</span><span class="va">batch</span> <span class="op">==</span> <span class="va">i</span><span class="op">]</span>, </span>
<span>                                <span class="va">scMerge2_res</span><span class="op">$</span><span class="va">fullalpha</span>,</span>
<span>                                ctl <span class="op">=</span> <span class="va">segList_ensemblGeneID</span><span class="op">$</span><span class="va">mouse</span><span class="op">$</span><span class="va">mouse_scSEG</span>,</span>
<span>                                ruvK <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                adjusted_means <span class="op">=</span> <span class="va">adjusted_means</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">newY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">newY</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">example_sce</span>, <span class="st">"scMerge2"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">newY</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span>
<span><span class="va">example_sce</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocSingular/man/runPCA.html" class="external-link">runPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, exprs_values <span class="op">=</span> <span class="st">'scMerge2'</span><span class="op">)</span>                                       </span>
<span><span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/plotPCA.html" class="external-link">plotPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, colour_by <span class="op">=</span> <span class="st">'cellTypes'</span>, shape <span class="op">=</span> <span class="st">'batch'</span><span class="op">)</span></span></code></pre></div>
<p><img src="scMerge2_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Note that we can also adjust only a subset of genes by input a gene
list in <code>return_subset_genes</code> in both
<code><a href="../reference/getAdjustedMat.html">getAdjustedMat()</a></code> and <code><a href="../reference/scMerge2.html">scMerge2()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="hierarchical-scmerge2">Hierarchical scMerge2<a class="anchor" aria-label="anchor" href="#hierarchical-scmerge2"></a>
</h3>
<p>scMerge2 provides a hierarchical merging strategy for data
integration that requires multiple level adjustment through function
<code><a href="../reference/scMerge2h.html">scMerge2h()</a></code>. For example, for the dataset with multiple
samples, we may want to remove the sample effect first within the
dataset before integrate it with other datasets. Below, we will
illustrate how we can build a hierarchical merging order as input for
<code><a href="../reference/scMerge2h.html">scMerge2h()</a></code>.</p>
<p>For illustration purpose, here I first create a fake sample
information for the sample data. Now, each batch has two samples.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a fake sample information</span></span>
<span><span class="va">example_sce</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">$</span><span class="va">sample</span>, <span class="va">example_sce</span><span class="op">$</span><span class="va">batch</span><span class="op">)</span></span>
<span><span class="co">#&gt;    </span></span>
<span><span class="co">#&gt;     batch2 batch3</span></span>
<span><span class="co">#&gt;   1     50      0</span></span>
<span><span class="co">#&gt;   2     50      0</span></span>
<span><span class="co">#&gt;   3      0     50</span></span>
<span><span class="co">#&gt;   4      0     50</span></span></code></pre></div>
<p>To perform <code>scMerge2h</code>, we need to create</p>
<ol style="list-style-type: decimal">
<li>a hierarchical index list that indicates the indices of the cells
that are going into merging;</li>
<li>a batch information list that indicates the batch information of
each merging.</li>
</ol>
<div class="section level4">
<h4 id="scenario-1">Scenario 1<a class="anchor" aria-label="anchor" href="#scenario-1"></a>
</h4>
<p>We will first illustrate that a two-level merging case, where the
first level refers to the sample effect removal within each batch, and
the second level refers to the merging of two batches.</p>
<p>First, we will construct the hierarchical index list
(<code>h_idx_list</code>). The hierarchical index list is a list that
indicates for each level, which indices of the cells are going into
merging. The number of the element of the list should be the same with
the number of level of merging. For each element, it should contain a
list of vectors of indices of each merging.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Construct a hierarchical index list</span></span>
<span><span class="va">h_idx_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>level1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/splitAsList.html" class="external-link">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span><span class="op">)</span>, <span class="va">example_sce</span><span class="op">$</span><span class="va">batch</span><span class="op">)</span>,</span>
<span>                   level2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>On level 1, we will perform two merging, one for each batch.
Therefore, we have a list of two vectors of indices. Each indicates the
indices of the cells of the batches.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h_idx_list</span><span class="op">$</span><span class="va">level1</span></span>
<span><span class="co">#&gt; $batch2</span></span>
<span><span class="co">#&gt;   [1]   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18</span></span>
<span><span class="co">#&gt;  [19]  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36</span></span>
<span><span class="co">#&gt;  [37]  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53  54</span></span>
<span><span class="co">#&gt;  [55]  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71  72</span></span>
<span><span class="co">#&gt;  [73]  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87  88  89  90</span></span>
<span><span class="co">#&gt;  [91]  91  92  93  94  95  96  97  98  99 100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $batch3</span></span>
<span><span class="co">#&gt;   [1] 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118</span></span>
<span><span class="co">#&gt;  [19] 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136</span></span>
<span><span class="co">#&gt;  [37] 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154</span></span>
<span><span class="co">#&gt;  [55] 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172</span></span>
<span><span class="co">#&gt;  [73] 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190</span></span>
<span><span class="co">#&gt;  [91] 191 192 193 194 195 196 197 198 199 200</span></span></code></pre></div>
<p>On level 2, we will perform one merging to merge two batches.
Therefore, we have a list of one vector of indices, indicates all the
indices of the cells of the full data.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h_idx_list</span><span class="op">$</span><span class="va">level2</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   [1]   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18</span></span>
<span><span class="co">#&gt;  [19]  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36</span></span>
<span><span class="co">#&gt;  [37]  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53  54</span></span>
<span><span class="co">#&gt;  [55]  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71  72</span></span>
<span><span class="co">#&gt;  [73]  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87  88  89  90</span></span>
<span><span class="co">#&gt;  [91]  91  92  93  94  95  96  97  98  99 100 101 102 103 104 105 106 107 108</span></span>
<span><span class="co">#&gt; [109] 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126</span></span>
<span><span class="co">#&gt; [127] 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144</span></span>
<span><span class="co">#&gt; [145] 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162</span></span>
<span><span class="co">#&gt; [163] 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180</span></span>
<span><span class="co">#&gt; [181] 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198</span></span>
<span><span class="co">#&gt; [199] 199 200</span></span></code></pre></div>
<p>Next, we need to create the batch information list
(<code>batch_list</code>), which has the same structure with the
<code>h_idx_list</code>, but indicates the batch label of the
<code>h_idx_list</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Construct a batch information list</span></span>
<span><span class="va">batch_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>level1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/splitAsList.html" class="external-link">split</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">$</span><span class="va">sample</span>, <span class="va">example_sce</span><span class="op">$</span><span class="va">batch</span><span class="op">)</span>,</span>
<span>                   level2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">$</span><span class="va">batch</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can see <code>batch_list</code> indicates the batch label for
level of the merging.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">batch_list</span><span class="op">$</span><span class="va">level1</span></span>
<span><span class="co">#&gt; $batch2</span></span>
<span><span class="co">#&gt;   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;  [38] 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2</span></span>
<span><span class="co">#&gt;  [75] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $batch3</span></span>
<span><span class="co">#&gt;   [1] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3</span></span>
<span><span class="co">#&gt;  [38] 3 3 3 3 3 3 3 3 3 3 3 3 3 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4</span></span>
<span><span class="co">#&gt;  [75] 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4</span></span></code></pre></div>
<p>Now, we can input the <code>batch_list</code> and
<code>h_idx_list</code> in <code>scMerge2h</code> to merge the data
hierarchically. We also need to input a <code>ruvK_list</code>, a vector
of number of unwanted variation (k in RUV model) for each level of the
merging. We suggest a lower <code>ruvK</code> in the first level. Here
we set <code>ruvK_list = c(2, 5)</code> which indicates we will set
RUV’s k equal to 2 in the first level and 5 in the second level.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scMerge2_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scMerge2h.html">scMerge2h</a></span><span class="op">(</span>exprsMat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span>,</span>
<span>                          batch_list <span class="op">=</span> <span class="va">batch_list</span>,</span>
<span>                          h_idx_list <span class="op">=</span> <span class="va">h_idx_list</span>,</span>
<span>                          ctl <span class="op">=</span> <span class="va">segList_ensemblGeneID</span><span class="op">$</span><span class="va">mouse</span><span class="op">$</span><span class="va">mouse_scSEG</span>,</span>
<span>                          ruvK_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>                          verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The output of <code>scMerge2h</code> is a list of matrices indicates
the adjusted matrix from each level.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">scMerge2_res</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">scMerge2_res</span>, <span class="va">dim</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 1047  200</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 1047  200</span></span></code></pre></div>
<p>Here we will use the adjusted matrix from the last level as the final
adjusted matrix.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">example_sce</span>, <span class="st">"scMerge2"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">scMerge2_res</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">h_idx_list</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span>
<span><span class="va">example_sce</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocSingular/man/runPCA.html" class="external-link">runPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, exprs_values <span class="op">=</span> <span class="st">'scMerge2'</span><span class="op">)</span>                           </span>
<span><span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/plotPCA.html" class="external-link">plotPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, colour_by <span class="op">=</span> <span class="st">'cellTypes'</span>, shape <span class="op">=</span> <span class="st">'batch'</span><span class="op">)</span></span></code></pre></div>
<p><img src="scMerge2_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="scenario-2">Scenario 2<a class="anchor" aria-label="anchor" href="#scenario-2"></a>
</h4>
<p>scMerge2h can handle a flexible merging strategy input. For example,
on level 1 above, we can only merge data for one batch. As an example,
we can start from modify the batch index list and hierarchical index
list to remove the list of batch 2 on level 1.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h_idx_list2</span> <span class="op">&lt;-</span> <span class="va">h_idx_list</span></span>
<span><span class="va">batch_list2</span> <span class="op">&lt;-</span> <span class="va">batch_list</span></span>
<span><span class="va">h_idx_list2</span><span class="op">$</span><span class="va">level1</span><span class="op">$</span><span class="va">batch2</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">batch_list2</span><span class="op">$</span><span class="va">level1</span><span class="op">$</span><span class="va">batch2</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">h_idx_list2</span><span class="op">)</span></span>
<span><span class="co">#&gt; $level1</span></span>
<span><span class="co">#&gt; $level1$batch3</span></span>
<span><span class="co">#&gt;   [1] 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118</span></span>
<span><span class="co">#&gt;  [19] 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136</span></span>
<span><span class="co">#&gt;  [37] 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154</span></span>
<span><span class="co">#&gt;  [55] 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172</span></span>
<span><span class="co">#&gt;  [73] 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190</span></span>
<span><span class="co">#&gt;  [91] 191 192 193 194 195 196 197 198 199 200</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $level2</span></span>
<span><span class="co">#&gt; $level2[[1]]</span></span>
<span><span class="co">#&gt;   [1]   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18</span></span>
<span><span class="co">#&gt;  [19]  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36</span></span>
<span><span class="co">#&gt;  [37]  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53  54</span></span>
<span><span class="co">#&gt;  [55]  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71  72</span></span>
<span><span class="co">#&gt;  [73]  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87  88  89  90</span></span>
<span><span class="co">#&gt;  [91]  91  92  93  94  95  96  97  98  99 100 101 102 103 104 105 106 107 108</span></span>
<span><span class="co">#&gt; [109] 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126</span></span>
<span><span class="co">#&gt; [127] 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144</span></span>
<span><span class="co">#&gt; [145] 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162</span></span>
<span><span class="co">#&gt; [163] 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180</span></span>
<span><span class="co">#&gt; [181] 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198</span></span>
<span><span class="co">#&gt; [199] 199 200</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">batch_list2</span><span class="op">)</span></span>
<span><span class="co">#&gt; $level1</span></span>
<span><span class="co">#&gt; $level1$batch3</span></span>
<span><span class="co">#&gt;   [1] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3</span></span>
<span><span class="co">#&gt;  [38] 3 3 3 3 3 3 3 3 3 3 3 3 3 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4</span></span>
<span><span class="co">#&gt;  [75] 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $level2</span></span>
<span><span class="co">#&gt; $level2[[1]]</span></span>
<span><span class="co">#&gt;   [1] batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2</span></span>
<span><span class="co">#&gt;  [11] batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2</span></span>
<span><span class="co">#&gt;  [21] batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2</span></span>
<span><span class="co">#&gt;  [31] batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2</span></span>
<span><span class="co">#&gt;  [41] batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2</span></span>
<span><span class="co">#&gt;  [51] batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2</span></span>
<span><span class="co">#&gt;  [61] batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2</span></span>
<span><span class="co">#&gt;  [71] batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2</span></span>
<span><span class="co">#&gt;  [81] batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2</span></span>
<span><span class="co">#&gt;  [91] batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2 batch2</span></span>
<span><span class="co">#&gt; [101] batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3</span></span>
<span><span class="co">#&gt; [111] batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3</span></span>
<span><span class="co">#&gt; [121] batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3</span></span>
<span><span class="co">#&gt; [131] batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3</span></span>
<span><span class="co">#&gt; [141] batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3</span></span>
<span><span class="co">#&gt; [151] batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3</span></span>
<span><span class="co">#&gt; [161] batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3</span></span>
<span><span class="co">#&gt; [171] batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3</span></span>
<span><span class="co">#&gt; [181] batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3</span></span>
<span><span class="co">#&gt; [191] batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3 batch3</span></span>
<span><span class="co">#&gt; Levels: batch2 batch3</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scMerge2_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scMerge2h.html">scMerge2h</a></span><span class="op">(</span>exprsMat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span>,</span>
<span>                          batch_list <span class="op">=</span> <span class="va">batch_list2</span>,</span>
<span>                          h_idx_list <span class="op">=</span> <span class="va">h_idx_list2</span>,</span>
<span>                          ctl <span class="op">=</span> <span class="va">segList_ensemblGeneID</span><span class="op">$</span><span class="va">mouse</span><span class="op">$</span><span class="va">mouse_scSEG</span>,</span>
<span>                          ruvK_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>                          verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">example_sce</span>, <span class="st">"scMerge2"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">scMerge2_res</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">h_idx_list</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span>
<span><span class="va">example_sce</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocSingular/man/runPCA.html" class="external-link">runPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, exprs_values <span class="op">=</span> <span class="st">'scMerge2'</span><span class="op">)</span>                           </span>
<span><span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/plotPCA.html" class="external-link">plotPCA</a></span><span class="op">(</span><span class="va">example_sce</span>, colour_by <span class="op">=</span> <span class="st">'cellTypes'</span>, shape <span class="op">=</span> <span class="st">'batch'</span><span class="op">)</span></span></code></pre></div>
<p><img src="scMerge2_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.3.1 (2023-06-16)</span></span>
<span><span class="co">#&gt; Platform: x86_64-apple-darwin20 (64-bit)</span></span>
<span><span class="co">#&gt; Running under: macOS Monterey 12.6.7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt; [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: internal</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">#&gt; [8] base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt;  [1] scater_1.28.0               ggplot2_3.4.2              </span></span>
<span><span class="co">#&gt;  [3] scuttle_1.10.1              scMerge_1.15.0             </span></span>
<span><span class="co">#&gt;  [5] SingleCellExperiment_1.22.0 SummarizedExperiment_1.30.2</span></span>
<span><span class="co">#&gt;  [7] Biobase_2.60.0              GenomicRanges_1.52.0       </span></span>
<span><span class="co">#&gt;  [9] GenomeInfoDb_1.36.1         IRanges_2.34.1             </span></span>
<span><span class="co">#&gt; [11] S4Vectors_0.38.1            BiocGenerics_0.46.0        </span></span>
<span><span class="co">#&gt; [13] MatrixGenerics_1.12.3       matrixStats_1.0.0          </span></span>
<span><span class="co">#&gt; [15] BiocStyle_2.28.0           </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;   [1] RColorBrewer_1.1-3        rstudioapi_0.15.0        </span></span>
<span><span class="co">#&gt;   [3] jsonlite_1.8.7            magrittr_2.0.3           </span></span>
<span><span class="co">#&gt;   [5] ggbeeswarm_0.7.2          farver_2.1.1             </span></span>
<span><span class="co">#&gt;   [7] rmarkdown_2.23            fs_1.6.3                 </span></span>
<span><span class="co">#&gt;   [9] zlibbioc_1.46.0           ragg_1.2.5               </span></span>
<span><span class="co">#&gt;  [11] vctrs_0.6.3               memoise_2.0.1            </span></span>
<span><span class="co">#&gt;  [13] DelayedMatrixStats_1.22.1 RCurl_1.98-1.12          </span></span>
<span><span class="co">#&gt;  [15] base64enc_0.1-3           htmltools_0.5.5          </span></span>
<span><span class="co">#&gt;  [17] S4Arrays_1.0.5            BiocNeighbors_1.18.0     </span></span>
<span><span class="co">#&gt;  [19] Formula_1.2-5             sass_0.4.7               </span></span>
<span><span class="co">#&gt;  [21] StanHeaders_2.26.27       reldist_1.7-2            </span></span>
<span><span class="co">#&gt;  [23] KernSmooth_2.23-21        bslib_0.5.0              </span></span>
<span><span class="co">#&gt;  [25] htmlwidgets_1.6.2         desc_1.4.2               </span></span>
<span><span class="co">#&gt;  [27] cachem_1.0.8              ResidualMatrix_1.10.0    </span></span>
<span><span class="co">#&gt;  [29] sfsmisc_1.1-15            igraph_1.5.0.1           </span></span>
<span><span class="co">#&gt;  [31] startupmsg_0.9.6          lifecycle_1.0.3          </span></span>
<span><span class="co">#&gt;  [33] pkgconfig_2.0.3           M3Drop_1.26.0            </span></span>
<span><span class="co">#&gt;  [35] rsvd_1.0.5                Matrix_1.5-4.1           </span></span>
<span><span class="co">#&gt;  [37] R6_2.5.1                  fastmap_1.1.1            </span></span>
<span><span class="co">#&gt;  [39] GenomeInfoDbData_1.2.10   digest_0.6.33            </span></span>
<span><span class="co">#&gt;  [41] numDeriv_2016.8-1.1       colorspace_2.1-0         </span></span>
<span><span class="co">#&gt;  [43] ps_1.7.5                  rprojroot_2.0.3          </span></span>
<span><span class="co">#&gt;  [45] dqrng_0.3.0               irlba_2.3.5.1            </span></span>
<span><span class="co">#&gt;  [47] textshaping_0.3.6         Hmisc_5.1-0              </span></span>
<span><span class="co">#&gt;  [49] beachmat_2.16.0           labeling_0.4.2           </span></span>
<span><span class="co">#&gt;  [51] fansi_1.0.4               abind_1.4-5              </span></span>
<span><span class="co">#&gt;  [53] mgcv_1.8-42               compiler_4.3.1           </span></span>
<span><span class="co">#&gt;  [55] withr_2.5.0               htmlTable_2.4.1          </span></span>
<span><span class="co">#&gt;  [57] backports_1.4.1           inline_0.3.19            </span></span>
<span><span class="co">#&gt;  [59] BiocParallel_1.34.2       viridis_0.6.4            </span></span>
<span><span class="co">#&gt;  [61] highr_0.10                pkgbuild_1.4.2           </span></span>
<span><span class="co">#&gt;  [63] gplots_3.1.3              MASS_7.3-60              </span></span>
<span><span class="co">#&gt;  [65] proxyC_0.3.3              DelayedArray_0.26.7      </span></span>
<span><span class="co">#&gt;  [67] bluster_1.10.0            gtools_3.9.4             </span></span>
<span><span class="co">#&gt;  [69] caTools_1.18.2            loo_2.6.0                </span></span>
<span><span class="co">#&gt;  [71] distr_2.9.2               tools_4.3.1              </span></span>
<span><span class="co">#&gt;  [73] vipor_0.4.5               foreign_0.8-84           </span></span>
<span><span class="co">#&gt;  [75] beeswarm_0.4.0            nnet_7.3-19              </span></span>
<span><span class="co">#&gt;  [77] glue_1.6.2                batchelor_1.16.0         </span></span>
<span><span class="co">#&gt;  [79] callr_3.7.3               nlme_3.1-162             </span></span>
<span><span class="co">#&gt;  [81] cvTools_0.3.2             grid_4.3.1               </span></span>
<span><span class="co">#&gt;  [83] checkmate_2.2.0           cluster_2.1.4            </span></span>
<span><span class="co">#&gt;  [85] gtable_0.3.3              data.table_1.14.8        </span></span>
<span><span class="co">#&gt;  [87] metapod_1.8.0             BiocSingular_1.16.0      </span></span>
<span><span class="co">#&gt;  [89] ScaledMatrix_1.8.1        utf8_1.2.3               </span></span>
<span><span class="co">#&gt;  [91] XVector_0.40.0            ggrepel_0.9.3            </span></span>
<span><span class="co">#&gt;  [93] pillar_1.9.0              stringr_1.5.0            </span></span>
<span><span class="co">#&gt;  [95] limma_3.56.2              robustbase_0.99-0        </span></span>
<span><span class="co">#&gt;  [97] splines_4.3.1             lattice_0.21-8           </span></span>
<span><span class="co">#&gt;  [99] densEstBayes_1.0-2.2      ruv_0.9.7.1              </span></span>
<span><span class="co">#&gt; [101] locfit_1.5-9.8            knitr_1.43               </span></span>
<span><span class="co">#&gt; [103] gridExtra_2.3             bookdown_0.34            </span></span>
<span><span class="co">#&gt; [105] edgeR_3.42.4              xfun_0.39                </span></span>
<span><span class="co">#&gt; [107] statmod_1.5.0             DEoptimR_1.1-0           </span></span>
<span><span class="co">#&gt; [109] rstan_2.21.8              stringi_1.7.12           </span></span>
<span><span class="co">#&gt; [111] yaml_2.3.7                evaluate_0.21            </span></span>
<span><span class="co">#&gt; [113] codetools_0.2-19          bbmle_1.0.25             </span></span>
<span><span class="co">#&gt; [115] tibble_3.2.1              BiocManager_1.30.21.1    </span></span>
<span><span class="co">#&gt; [117] cli_3.6.1                 RcppParallel_5.1.7       </span></span>
<span><span class="co">#&gt; [119] rpart_4.1.19              systemfonts_1.0.4        </span></span>
<span><span class="co">#&gt; [121] munsell_0.5.0             processx_3.8.2           </span></span>
<span><span class="co">#&gt; [123] jquerylib_0.1.4           Rcpp_1.0.11              </span></span>
<span><span class="co">#&gt; [125] bdsmatrix_1.3-6           parallel_4.3.1           </span></span>
<span><span class="co">#&gt; [127] rstantools_2.3.1.1        pkgdown_2.0.7.9000       </span></span>
<span><span class="co">#&gt; [129] prettyunits_1.1.1         scran_1.28.2             </span></span>
<span><span class="co">#&gt; [131] sparseMatrixStats_1.12.2  bitops_1.0-7             </span></span>
<span><span class="co">#&gt; [133] viridisLite_0.4.2         mvtnorm_1.2-2            </span></span>
<span><span class="co">#&gt; [135] scales_1.2.1              purrr_1.0.1              </span></span>
<span><span class="co">#&gt; [137] crayon_1.5.2              rlang_1.1.1</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Yingxin Lin, Kevin Wang, Sydney Bioinformatics and Biometrics Group.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
